---
title: 数据导入指南
---
现在电子交易已经普及，银行、券商、支付软件等交易平台一般都可以导出历史交易记录。因此，很少有用户还需要手工记录每笔交易。与此同时，如何把各个平台上导出的格式各异的交易记录数据批量输入到TataruBook中成了最主要问题。

本页给出了一套可供参考的外部数据转换和导入方法。

# 原始数据的处理

平台提供的原始交易记录文件格式各异，可能是文本文件、csv文件、Excel文件、pdf文件等等。在第一步，需要把交易记录文件内容转换成Excel表格，而且要符合以下要求：

- 每一行表示一笔交易；
- 交易按照时间升序排列（尤其注意同一天内的多笔交易的顺序，因为这是以后按日期排序解决不了的）。

下面给出一个虚拟的原始交易记录例子，它可能是从某个券商导出的交易记录文件，后面将会基于这个例子演示如何把数据导入到TataruBook：

| 流水号 | 清算周期 | 业务名称 | 发生金额 | 剩余金额 | 证券代码 | 证券名称 | 长简称 | 成交价格 | 成交数量 |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 20605 | 20230103 | 银行转存 | 8000 | 8000 |  |  |  | 0 | 0 |
| 506106 | 20230110 | 证券卖出 | 1281.17 | 0.61 | 123147 | 中辰转债 | 中辰转债 | 128.127 | -10 |
| 11612 | 20230215 | 银行转取 | -19999.97 | 0.03 |  |  |  | 0 | 0 |
| 492351 | 20230310 | 证券买入 | -60076.91 | 0.04 | 513050 | 中概互联 | 中概互联网ETF | 1.013 | 59300 |
| 546304 | 20230321 | 利息归本 | 2.83 | 2.83 |  |  |  | 0 | 0 |
| 744531 | 20230322 | 股息入账 | 2 | 2 | 113056 | 重银转债 | 重银转债 | 0 | 0 |
| 744535 | 20230322 | 兑息扣税 | -0.4 | 1.6 | 113056 |  | 重银转债 | 0 | 0 |
| 501079 | 20230324 | 证券卖出 | 60018 | 0.04 | 512980 | 传媒ETF | 传媒ETF | 0.82 | -73200 |

你的原始数据很可能和这个例子不一样，但没关系，只要数据符合前述的两条要求，后面的步骤只需要根据列的不同进行调整即可。

如果原始文件是csv格式或者Excel格式，那么这一步通常是非常容易的；如果原始文件是文本格式，那么可以利用Excel的文本导入向导将其转换成表格；如果原始文件是pdf等其他格式，通常可以把其中的文本复制出来保存成文本格式，然后再转换成表格。有的时候，数据并不符合每行一笔交易的要求，分隔符也可能不规律，这个时候可能需要考虑批量查找替换、正则表达式、Excel公式、编写脚本等其他处理方法。

小心Excel单元格中的多余空格、制表符、回车等字符——尤其当单元格内容为数字时。这些符号可能导致后续的处理步骤失败。而且由于这些字符在Excel中不可见，问题相当难以被发现。在处理原始文件时需要尽早将这些多余的字符删除。
{: .notice--warning}

# Excel数据转换模板

新建一个Excel文件，并将第一个工作表命名为`原始数据`，在里面贴入第一步的数据。

这个Excel文件将会成为针对这种交易数据格式的**转换模板**，以后只要是这种格式的数据，将其贴到`原始数据`工作表中，就能自动完成转换。

由于不同平台的原始数据格式不同，一般需要为每个平台建立不同的转换模板。

# 配置参数

在转换模板中新建一个工作表，命名为`参数`。

然后观察`原始数据`中，**根据什么信息可以决定每笔交易另一方的账户**。在上面的例子数据中，可以总结出以下规律：

- 如果`业务名称`列的内容是`银行转存`或者`银行转取`，那么交易另一方的账户是该证券账户绑定的银行账户；
- 如果`业务名称`列的内容是`证券卖出`、`证券买入`、`股息入账`或者`兑息扣税`，那么交易另一方的账户是`证券名称`那一列所代表的投资品（股票、基金或债券等等）；
- 如果`业务名称`列的内容是`利息归本`，那么交易另一方的账户是一个外部账户——利息收入。

根据这些规律，我们可以在“参数”工作表中建立原始信息和**另一方的账户**的对应关系，如下：

| 流水号 | 清算周期 |
|:-:|:-:|
| 银行转存 | 萨雷安银行活期 |
| 银行转取 | 萨雷安银行活期 |
| 利息归本 | 利息 |

注意对于另一方的账户是`证券名称`所代表的投资品的情况，由于原始数据中已经包含了账户信息，因此不需要在“参数”工作表中涉及。

当原始数据包含的是日常收支记录时，这一步骤可能会相当个性化。比如，如何界定一笔交易是餐饮费支出？——如果你大部分时候都在某个特定餐厅就餐，那么“参数”工作表中可以添加某列特征与`餐饮费`的对应关系。但是这往往不足以处理所有的数据，有一些特殊的消费或者收入，可能只能在原始数据中（或者在最后生成的结果中）进行人工处理。

# 筛选和转换需要的信息

`原始数据`中有一些列的信息是不需要导入的，比如`流水号`、`剩余金额`。当然，如果你觉得有必要，也可以把想要保留的信息放入[postings表]({{ site.baseurl }}/tables_and_views.html#postings)的`comment`字段。

但是最重要的还是记账需要的关键信息。在转换模板中新建一个工作表，命名为`中间结果`，关键信息将会被抓入这个工作表。

在表的第一行添加这几个列名：

| trade_date | this_account | amount | other_account | comment | other_change |

接着需要根据`原始数据`的结构，在每一列中填入公式来抓取数据。由于第一行是表头，第二行开始是实际数据，我们以每一列第二行的公式作为例子依次介绍：

`trade_date`列需要抓取交易日期。`原始数据`中交易日期所在的列是`清算周期`列，即B列。`原始数据`的交易日期是YYYYMMDD格式，需要转换成Excel的日期格式。设计这样的公式完成转换：`=DATE(LEFT(原始数据!B2,4),MID(原始数据!B2,5,2),RIGHT(原始数据!B2,2))`。这个公式使用了字符串处理函数和日期构造函数。如果你的`原始数据`中日期格式不是这样的，那么需要设计与之对应的公式。

`this_account`是`原始数据`的所有交易所在的账户，一般来说就是导出数据的平台对应的账户。在这个虚拟的例子中，我们在此列填入虚拟的账户名`莫古证券资金`。这一列不需要用公式，因为每笔交易的`this_account`值都是一样的。

如果你在同样的平台有多个不同账户，由于它们的数据格式都是一样的，可以用同一个转换模板进行转换。这种情况下，你可能需要把账户名配置为一个参数，并在`this_account`中引用这个参数。
{: .notice}

`amount`是`this_account`账户在交易中产生的金额变动，对应`原始数据`中D列`发生金额`。这一列的公式很简单，直接引用`原始数据`中D列的值就行了。填的公式是`=原始数据!D2`。

`other_account`是交易另一方的账户名字。在[配置参数]({{ site.baseurl }}/importing_data.html#配置参数)的步骤中，我们梳理了这个数据的规律。现在利用这个规律来设计公式：

- 如果`原始数据`中`业务名称`的值在`参数`工作表中A列出现了，那么`参数`工作表中B列的值就是另一方的账户名字。这个公式写为：`=VLOOKUP(原始数据!C2,参数!A:B,2,FALSE)`。
- 如果`原始数据`中`业务名称`的值在`参数`工作表中A列找不到，说明另一方的账户名字由`原始数据`中`证券名称`这列的值所代表。注意`证券名称`这列的值并不一定等于账户名，还要取决于投资品账户的命名规则。在我们的例子中，假设账户的命名规则是`券商名_证券名称`，比如`莫古证券_中辰转债`。那么设计出的公式为：`=CONCAT("莫古证券_",原始数据!G2)`
- 把上面的两个处理分支用IF判断函数组合起来，得到完整公式：`=IF(COUNTIF(参数!A:A,原始数据!C2)>0,VLOOKUP(原始数据!C2,参数!A:B,2,FALSE),CONCAT("莫古证券_",原始数据!G2))`

`comment`是对交易的备注信息，这一列中填什么数据取决于用户的喜好。我们这里直接抓取`业务名称`放到备注中：`=原始数据!C2`

`other_change`是交易另一方的账户发生的变动数量，它只在部分交易中存在。在我们的例子中它对应的是`原始数据`中的J列`成交数量`。但是观察发现，当这个值不应该存在时（比如`银行转存`交易），`原始数据`中的`成交数量`为`0`。为了不错误的填入`0`值，我们设计一个带有筛选条件的公式：`=IF(COUNTIF(参数!A:A,原始数据!C2)>0,"",原始数据!J2)`

所有公式都设计好之后，利用Excel的公式自动填充功能，把所有行的数据都计算出来如下：

| trade_date | this_account | amount | other_account | comment | other_change |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 2023/1/3 | 莫古证券资金 | 8000 | 萨雷安银行活期 | 银行转存 | |
| 2023/1/10 | 莫古证券资金 | 1281.17 | 莫古证券_中辰转债 | 证券卖出 | -10 |
| 2023/2/15 | 莫古证券资金 | -19999.97 | 萨雷安银行活期 | 银行转取 | |
| 2023/3/10 | 莫古证券资金 | -60076.91 | 莫古证券_中概互联 | 证券买入 | 59300 |
| 2023/3/21 | 莫古证券资金 | 2.83 | 利息 | 利息归本 | |
| 2023/3/22 | 莫古证券资金 | 2 | 莫古证券_重银转债 | 股息入账 | 0 |
| 2023/3/22 | 莫古证券资金 | -0.4 | 莫古证券_ | 兑息扣税 | 0 |
| 2023/3/24 | 莫古证券资金 | 60018 | 莫古证券_传媒ETF | 证券卖出 | -73200 |

# 检查中间结果的正确性

对于`中间结果`，最好进行一遍人工检视。在上面的例子中，检视将发现一个问题：`2023/3/22`的`兑息扣税`交易，`other_account`的值是错误的：`莫古证券_`。回顾`原始数据`就能发现，这一行中`证券名称`的值是空的。解决的方法是手工在`原始数据`的`证券名称`里填入值`重银转债`，之后`other_account`就能正常显示为`莫古证券_重银转债`。

由于`原始数据`的每笔交易并不一定总是严格遵循一致规则，有时候数据会存在一些异常情况，因此人工进行少量处理可能是需要的。但是注意应该只修改`原始数据`工作表，不要直接修改`中间结果`工作表，否则将会破坏编写的公式，使得转换模板下次不能再被重用。

# 选择源账户和目标账户

在转换模板中新建一个工作表，命名为`最终结果`。