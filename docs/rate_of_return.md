---
title: 收益率计算方法
---
本页介绍一些常见的投资收益率计算方法。

# 一些基本约定

在计算收益率时，首先要统一度量单位，即统一货币单位。所有的投资品、流入流出资金都需要按照市场价格换算成某一种货币来进行计算。在TataruBook中，[标准资产]({{ site.baseurl }}/table_view.html#standard_asset)是用户指定的统一度量货币。

**利润**或**亏损**是以绝对金额度量的，而**收益率**是以比例来度量的，**年化收益率**是把某段周期的收益率按特定算法换算成以一年为周期的收益率。TataruBook不会对收益率进行年化换算，因此TataruBook计算出的指定周期收益率有时也被叫做[持有期收益率（holding period return）](https://en.wikipedia.org/wiki/Holding_period_return)。

收益率可以对单个投资品种进行计算，也可以对多个投资品种构成的**投资组合**进行计算。由于投资组合也可以看作为单个投资品，因此计算收益率的方法对它们两者往往都能适用。另一方面，TataruBook也会使用一些技巧，把单个投资品和一个虚拟的现金账户构成一个投资组合，来消除计算时资金流入流出的影响（见最小初始资金法）。

# 无资金流入流出时的计算

假设在期初，投资品的市场价值为$$ V_s $$；期末，投资品及衍生收益的市场价值为$$ V_e $$，那么收益率$$ R $$为：

$$ R = \frac{V_e - V_s}{V_s} $$

注意对于完整的收益率$$ R $$来说，$$ V_e $$包括了该项投资在此周期内获得的所有利息、分红、票息等收益，而不仅仅是投资品在期末的市场价值。

TataruBook在计算单账户收益率时，既可以把利息收益合并计算，也可以单独剥离利息收益。当利息收益被剥离计算时，每次该账户获得的利息都会被视作资金流入（追加投入）。见[return_on_shares视图]({{ site.baseurl }}/table_view.html#return_on_shares)的说明。
{: .notice}

举例：如果期初持有某股票$$ 100 $$股，每股价格$$ 10 $$元，那么期初价值为$$ 10 \times 100 = 1000 $$元。在周期内，该股票进行了每股$$ 0.5 $$元的分红，期末时该股票价格为每股$$ 9.8 $$元，则获得的分红总计为$$ 0.5 \times 100 = 50 $$元，期末持有的股票价值为$$ 9.8 \times 100 = 980 $$元。因此，$$ V_e = 980 + 50 = 1030 $$元，收益率$$\displaystyle R = \frac{30}{1000} = 3\% $$。

这种算法简单易懂，但是只适用于整个周期内没有资金流入流出的情况。在上面这个例子中，如果投资者在期中追加买入了$$ 100 $$股，买入价格仍是$$ 10 $$元，那么期末时市场价值为$$ 2060 $$元（原例子的两倍），这时沿用原公式算出的收益率为$$\displaystyle R = \frac{2060 - 1000}{1000} = 106\% $$，显然这个收益率是不准确的。

有人可能会想：那把整个周期内的新增流入资金加到期初价值中去是否可行呢？——对于这个例子来说没问题，因为这个例子里只有资金流入没有流出。但实际情况可能比这复杂得多，比如一个短线交易者可能每天都有大笔资金流入和流出，如果只累加所有的资金流入，收益率计算结果也是不准确的。

显然，我们需要一些方法来补偿资金流入流出所造成的影响。下面介绍几种常见的方法。

# 简单Dietz方法

[简单Dietz方法](https://en.wikipedia.org/wiki/Simple_Dietz_method)把周期内所有资金流入流出累加计算出**净流入**$$ F $$（如果为净流出，则净流入的值为负数），然后看作在整个周期的**中点**产生了这笔净流入。这样，期初的价值就应当加上净流入的一半，即：

$$ R = \frac{V_e - V_s - F}{V_s + \displaystyle \frac{F}{2}} $$

简单Dietz方法基于这样一个假设：资金的流入流出在整个周期中是大致平均的发生的，因此可以看作在周期中点的一次净流入来简化计算。

举例：假设投资周期有3天，每天的股价和资金流入流出如下：

| 天 | 股价 | 新增股数 | 流入资金 | 持有股数 | 市场价值 |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 0 | 10 | 0 | 0 | 10 | 100 |
| 1 | 12 | 5 | 60 | 15 | 180 |
| 2 | 11 | 0 | 0 | 15 | 165 |

则简单Dietz方法计算的收益率为：

$$ R = \frac{V_e - V_s - F}{V_s + \displaystyle \frac{F}{2}} = \frac{165 - 100 - 60}{100 + \displaystyle \frac{60}{2}} = \frac{5}{130} \approx 3.85\% $$

简单Dietz方法的缺点是：如果资金的流入流出在整个周期中并不是平均分布的，那么计算结果会不准确。假设一种极端情况：在长达一年的周期中，初始市场价值为$$ 0 $$；在第$$ 2 $$天，大笔资金流入并买入股票；在第$$ 364 $$天，所有的资金流出。由于整个周期中资金净流入（总流入减总流出）是个绝对值很小的值（甚至可能为$$ 0 $$），故公式里分母的值非常小（或者为$$ 0 $$），导致收益率产生很大偏差。

尽管简单Dietz方法存在缺点，但个人或家庭的整体资金流入流出往往很接近简单Dietz方法的假设（即流入和流出在时间上大致分布均匀）。因此TataruBook在计算整个组合的收益率时使用简单Dietz方法。（见[portfolio_stats视图]({{ site.baseurl }}/table_view.html#portfolio_stats)）。
{: .notice}

# 修改的Dietz方法

为了解决简单Dietz方法的缺点，[修改的Dietz方法](https://en.wikipedia.org/wiki/Modified_Dietz_method)不再假设在周期的中点产生净流入，而是按实际的流入流出时间计算出周期内的**平均资本**，再用平均资本作为分母：

$$ R = \frac{V_e - V_s - F}{V_s + \displaystyle \sum_{i=1}^{n} W_i \times F_i} $$

其中，$$ F = \displaystyle \sum_{i=1}^{n} F_i $$，是整个周期的净流入；$$ F_i $$是第$$ i $$次的流入或流出金额（流入为正值，流出为负值）；$$ W_i $$是第$$ i $$次流入或流出的**权重**，权重是根据流入或流出发生的时间计算出来的，即：

$$ W_i = \frac{T - t_i}{T} $$

其中$$ T $$为整个周期的时间长度；$$ t_i $$为第$$ i $$次流入或流出发生的时间距离期初的时间长度。流入或流出发生得越早，其权重越高，对于收益率的影响越大。

举例：假设投资周期有365天，每天的股价和资金流入流出如下（中间没有变化的天省略掉）：

| 天 | 股价 | 新增股数 | 流入资金 | 持有股数 | 市场价值 |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 0 | 10 | 0 | 0 | 0 | 0 |
| 1 | 10 | 1100 | 11000 | 1100 | 11000 |
| 364 | 11 | -1000 | -11000 | 100 | 1100 |
| 365 | 11 | 0 | 0 | 100 | 1100 |

则修改的Dietz方法计算收益率的过程为：

$$ W_0 = \frac{365 - 1}{365} \approx 0.997 $$

$$ W_1 = \frac{365 - 364}{365} \approx 0.003 $$

$$ R = \frac{V_e - V_s - F}{V_s + \displaystyle \sum_{i=1}^{n} W_i \times F_i} \approx \frac{1100 - 0 - 0}{0 + 0.997 \times 11000 - 0.003 \times 11000} \approx 10\% $$

这个计算结果是非常符合直觉的，因为股价从$$ 10 $$涨到$$ 11 $$正好上涨了$$ 10\% $$。如果用简单Dietz方法对这个例子进行计算，会因为分母为$$ 0 $$而无法计算。

一般来说，如果投资品的收益随着时间稳定增长（如存款、货币基金），那么修改的Dietz方法计算的收益率往往非常准确。但是，如果投资品的价格剧烈变化，那么修改的Dietz方法计算的结果可能出现不小的偏差。在上面的例子中，如果资金流入不是在第$$ 1 $$天而是在第$$ 363 $$天，那么计算出的全周期平均资本会很小，导致收益率为一个巨大的数字，和实际不符。

由于修改的Dietz方法计算利息类收益的准确性，TataruBook在计算每个账户的利息收益率时使用修改的Dietz方法。（见[interest_rates视图]({{ site.baseurl }}/table_view.html#interest_rates)）。
{: .notice}

# 内部收益率（IRR）

[内部收益率](https://en.wikipedia.org/wiki/Internal_rate_of_return)是使得所有流入和流出的[净现值](https://en.wikipedia.org/wiki/Net_present_value)恰好等于$$ 0 $$的收益率。通俗的讲，假设投资品价值一直以固定的速率$$ R $$增长，在这个假设下，如果该投资品的期初价值、所有流入流出、期末价值刚好能和实际匹配，则满足该假设的$$ R $$就是内部收益率。

内部收益率的计算有一些特别的要求：流入或流出必须以固定的时间间隔发生，且最后计算的收益率$$ R $$是在这个时间间隔长度下的收益率。假设每间隔时间$$ T $$有一次流入或流出$$ F_i $$，那么在周期$$ T $$的内部收益率$$ R $$是这个方程的解：

$$ \sum_{i=0}^{n} \frac{F_i}{(1 + R)^i} = 0 $$

注意：计算内部收益率时，资金流入时$$ F_i $$为负数，资金流出时$$ F_i $$为正数，这和一些其它方法中的定义相反。$$ F_0 $$为期初的价值的相反数，即$$ F_0 = -V_s $$；$$ F_n $$为期末的价值，即$$ F_n = V_e $$。也就是说，把期初的价值看成一次资金流入，期末的价值看成一次资金流出。

举例：假设某项投资总时长$$ 3 $$年，每隔一年有一笔资金流出，如下：

| 年 | 资金流 |
|:-:|:-:|
| 0 | -123400 |
| 1 | 36200 |
| 2 | 54800 |
| 3 | 48100 |

那么，内部收益率就是下面这个方程的解：

$$ \sum_{i=0}^{n} \frac{F_i}{(1 + R)^i} = -123400 + \frac{36200}{(1 + R)} + \frac{54800}{(1 + R)^2} + \frac{48100}{(1 + R)^3} = 0 $$

可解出一年的内部收益率$$ R \approx 5.96\% $$

内部收益率在现实中有广泛的应用。比如，对于每月需要归还固定金额（分期还款）的贷款，内部收益率代表该贷款的真实利率。但是，内部收益率也存在很多缺点。比如，如果资金的流入流出不是以固定的时间间隔发生怎么办？——在个人理财中，可以粗糙的以天为周期来处理资金的流入流出，但这样计算出来的内部收益率是一天的收益率，不太直观。如果按年化的方法把一天的收益率换算成一年的收益率，又可能出现很大的偏差。

举个例子：某项投资总时长一年，期初价值为$$ 100 $$，在第一天末流出了$$ 101 $$，之后没有任何流入和流出，期末价值为$$ 0 $$。对这项投资，内部收益率计算出来是一天$$ 1\% $$。如果把收益率换算成年化，那么年化收益率为$$ (1 + 0.01)^365 \approx 37.78 $$倍。显然这个年化收益率是严重失真的。

内部收益率的另一个缺点是计算起来非常麻烦，需要解高次方程，手工几乎无法计算，只能编程求解。

由于SQLite数据库和Python标准库都没有直接提供计算内部收益率的接口，为了不增加安装的复杂度，且避免软件响应时间过长，TataruBook并没有直接提供内部收益率数据。但是，TataruBook提供了[periods_cash_flows视图]({{ site.baseurl }}/table_view.html#periods_cash_flows)，这个视图展示了整个组合在每天的资金流统计，可以把视图中的数据复制到Excel并用**XIRR函数**来计算组合的内部收益率。
{: .notice}

# 时间加权收益

[时间加权收益](https://en.wikipedia.org/wiki/Time-weighted_return)基于这样的思路：在任意两次资金流入流出之间的时间段里，是没有资金流入流出的，那么对于这个子周期可以应用[无资金流入流出时的计算方法]({{ site.baseurl }}/rate_of_return.html#无资金流入流出时的计算)来计算收益率。对每个子周期都计算出收益率后，可以把所有子周期的收益率相乘来得到总收益率。

要使用时间加权收益计算的话，仅仅知道组合的期初价值和期末价值是不够的，还必须知道每次资金流入流出时的组合价值。假设有$$ n - 1 $$次流入流出，那么$$ V_0 = V_s $$为期初价值；$$ V_n = V_e $$为期末价值；$$ V_i $$为在第$$ i $$次资金流入流出$$ F_i $$后的组合价值。则时间加权收益$$ R $$为这个方程的解：

$$ 1 + R = \frac{V_1 - F_1}{V_0} \times \frac{V_2 - F_2}{V_1} \times \frac{V_3 - F_3}{V_2} \times \dots \times \frac{V_{n-1} - F_{n-1}}{V_{n-2}} \times \frac{V_{n} - F_{n}}{V_{n-1}} $$

举例：假设投资周期为$$ 2 $$年，初始和每年末的股价及资金流入流出如下：

| 年 | 股价 | 新增股数 | 流入资金 | 持有股数 | 市场价值 |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 0 | 10 | 0 | 0 | 50 | 500 |
| 1 | 20 | 50 | 1000 | 100 | 2000 |
| 2 | 15 | 0 | 0 | 100 | 1500 |

那么，时间加权收益率为：

$$ \frac{V_1 - F_1}{V_0} \times \frac{V_2 - F_2}{V_1} - 1 = \frac{2000 - 1000}{500} \times \frac{1500 - 0}{2000} - 1 = 2 \times 0.75 - 1 = 50\% $$

这个收益率实际上是股价本身的变化率，并没有体现资金流入流出对真实收益的影响。如果观察这项投资的实际利润，会发现期初价值$$ 500 $$，中间增加投入$$ 1000 $$，期末价值$$ 1500 $$，实际收益为$$ 0 $$，与时间加权收益率不符。

但这正是时间加权收益的特点，它一般不用于计算单个投资品的收益率，而是用于计算整个组合的收益率。把整个组合看成一只基金，那么资金流入和流出相当于基金份额的申购和赎回，时间加权收益希望剔除这部分的影响，只体现基金本身的投资绩效。

如果投资组合的资金流入流出是不受管理者控制的，那么时间加权收益很好的体现了管理者的投资水平。但是如果组合的管理者同时也在控制着组合的资金流入流出，那么就像上面的例子那样，时间加权收益并没有反映真实的收益情况。

TataruBook没有提供时间加权收益功能，因为它要求每次资金流入流出时都要能对组合准确估值。对于个人或家庭记账来说，这意味着每次有消费或收入时，都必须提供组合里所有非标准资产的价格，这不是一件容易的事。未来如果有自动化的批量获取价格方法，TataruBook可能会考虑增加时间加权收益功能。
{: .notice}